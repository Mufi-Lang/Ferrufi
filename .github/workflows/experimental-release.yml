name: Experimental Release - Build App

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      version_override:
        description: "Version override (e.g., 0.1.0-beta1, leave empty for auto)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-app:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read Swift tools version from Package.swift
        id: swift-version
        run: |
          SWIFT_VERSION=$(awk '/^\/\/ swift-tools-version:/ { print $3; exit }' Package.swift)
          echo "version=$SWIFT_VERSION" >> "$GITHUB_OUTPUT"
          echo "Detected Swift version: $SWIFT_VERSION"

      - name: Set up Swift toolchain
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: ${{ steps.swift-version.outputs.version }}

      - name: Get version from Version.swift
        id: app-version
        run: |
          MAJOR=$(grep -E '^\s*public static let major = ' Sources/Ferrufi/Version.swift | sed 's/.*= //' | tr -d ' ')
          MINOR=$(grep -E '^\s*public static let minor = ' Sources/Ferrufi/Version.swift | sed 's/.*= //' | tr -d ' ')
          PATCH=$(grep -E '^\s*public static let patch = ' Sources/Ferrufi/Version.swift | sed 's/.*= //' | tr -d ' ')
          VERSION="${MAJOR}.${MINOR}.${PATCH}"

          # Create experimental version suffix
          EXP_VERSION="${VERSION}-exp.${{ github.run_number }}.$(git rev-parse --short HEAD)"

          echo "base_version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "exp_version=$EXP_VERSION" >> "$GITHUB_OUTPUT"
          echo "Base version: $VERSION"
          echo "Experimental version: $EXP_VERSION"

      - name: Determine final version
        id: final-version
        run: |
          if [ -n "${{ inputs.version_override }}" ]; then
            VERSION="${{ inputs.version_override }}"
            echo "Using manual override version: $VERSION"
          else
            VERSION="${{ steps.app-version.outputs.exp_version }}"
            echo "Using auto-generated version: $VERSION"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Make scripts executable
        run: |
          chmod +x scripts/build_app.sh
          chmod +x scripts/set_version.sh
          chmod +x scripts/test_linking.sh

      - name: Verify libmufiz.dylib
        run: |
          if [ ! -f "Sources/CMufi/libmufiz.dylib" ]; then
            echo "ERROR: libmufiz.dylib not found!"
            exit 1
          fi
          echo "âœ“ libmufiz.dylib found"
          lipo -info Sources/CMufi/libmufiz.dylib

          echo "Checking entitlements file..."
          if [ ! -f "Ferrufi.entitlements" ]; then
            echo "ERROR: Ferrufi.entitlements not found!"
            exit 1
          fi
          echo "âœ“ Entitlements file found"

      - name: Run linking tests
        run: |
          ./scripts/test_linking.sh

      - name: Build App with Zip
        run: |
          ./scripts/build_app.sh \
            --version "${{ steps.final-version.outputs.version }}" \
            --zip

      - name: Verify Build Artifacts
        id: verify-build
        run: |
          ZIP_FILE="Ferrufi-${{ steps.final-version.outputs.version }}-macos.zip"
          APP_BUNDLE="Ferrufi.app"

          if [ ! -f "$ZIP_FILE" ]; then
            echo "ERROR: Zip file not created!"
            exit 1
          fi

          if [ ! -d "$APP_BUNDLE" ]; then
            echo "ERROR: App bundle not created!"
            exit 1
          fi

          ZIP_SIZE=$(du -h "$ZIP_FILE" | cut -f1)
          APP_SIZE=$(du -sh "$APP_BUNDLE" | cut -f1)

          echo "âœ“ App created: $APP_BUNDLE ($APP_SIZE)"
          echo "âœ“ Zip created: $ZIP_FILE ($ZIP_SIZE)"

          # Verify entitlements are applied
          echo "Verifying entitlements..."
          if codesign -d --entitlements - "$APP_BUNDLE" 2>&1 | grep -q "com.apple.security.files.all"; then
            echo "âœ“ Entitlements verified"
          else
            echo "âš  Warning: Entitlements may not be applied correctly"
          fi

          echo "zip_path=$ZIP_FILE" >> "$GITHUB_OUTPUT"
          echo "zip_name=$(basename $ZIP_FILE)" >> "$GITHUB_OUTPUT"
          echo "zip_size=$ZIP_SIZE" >> "$GITHUB_OUTPUT"
          echo "app_size=$APP_SIZE" >> "$GITHUB_OUTPUT"

      - name: Upload Zip as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ferrufi-experimental-zip
          path: ${{ steps.verify-build.outputs.zip_path }}
          retention-days: 30

      - name: Check if experimental release exists
        id: check-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh release view experimental >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Experimental release exists"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Experimental release does not exist"
          fi

      - name: Create or update experimental release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_TAG="experimental"
          ZIP_FILE="${{ steps.verify-build.outputs.zip_path }}"
          VERSION="${{ steps.final-version.outputs.version }}"

          # Create release notes
          cat > release_notes.md <<EOF
          # Ferrufi Experimental Build

          **Version:** $VERSION
          **Build:** #${{ github.run_number }}
          **Commit:** \`${{ github.sha }}\`
          **Branch:** ${{ github.ref_name }}
          **Built:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          ## âš ï¸ Experimental Build Warning

          This is an **experimental/development build** and may contain bugs or incomplete features.
          - Not code-signed
          - For testing purposes only
          - May be unstable

          ## Installation

          1. Download \`${{ steps.verify-build.outputs.zip_name }}\` (or the stable asset \`Ferrufi-experimental.zip\`)
          2. Double-click to extract \`Ferrufi.app\`
          3. Drag \`Ferrufi.app\` to Applications folder
          4. **Right-click the app and select "Open"** (first time only)
          5. Click "Open" in the security dialog

          **Quick install via terminal:**
          \`\`\`bash
          # Download and extract
          unzip ${{ steps.verify-build.outputs.zip_name }}

          # Copy to Applications
          cp -R Ferrufi.app /Applications/

          # Remove quarantine and launch
          xattr -cr /Applications/Ferrufi.app
          open /Applications/Ferrufi.app
          \`\`\`

          ## What's Included

          - âœ“ Ferrufi application (${{ steps.verify-build.outputs.app_size }})
          - âœ“ Mufi runtime (libmufiz.dylib) bundled
          - âœ“ Entitlements for file access enabled
          - âœ“ All features from commit ${{ github.sha }}

          ## Build Information

          - **Swift Version:** ${{ steps.swift-version.outputs.version }}
          - **Platform:** macOS 14.0+
          - **Architecture:** arm64 (Apple Silicon)
          - **Build Configuration:** Release
          - **Zip Size:** ${{ steps.verify-build.outputs.zip_size }}

          ## Links

          - [Source Code](${{ github.server_url }}/${{ github.repository }}/tree/${{ github.sha }})
          - [Commit](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          - [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Documentation](${{ github.server_url }}/${{ github.repository }}/blob/${{ github.sha }}/DISTRIBUTION_QUICKSTART.md)

          ---

          **Auto-generated experimental build** - Updated on every push to main/develop
          EOF

          # Delete existing release assets if release exists
          if [ "${{ steps.check-release.outputs.exists }}" = "true" ]; then
            echo "Updating existing experimental release..."

            # Delete old zip assets
            gh release view experimental --json assets -q '.assets[].name' | \
              grep -E '\.(zip|dmg)$' | \
              xargs -I {} gh release delete-asset experimental {} --yes 2>/dev/null || true

            # Update release
            gh release edit experimental \
              --notes-file release_notes.md \
              --title "Experimental Build #${{ github.run_number }}"
          else
            echo "Creating new experimental release..."
            gh release create experimental \
              --title "Experimental Build #${{ github.run_number }}" \
              --notes-file release_notes.md \
              --prerelease \
              --target ${{ github.sha }}
          fi

          # Upload new zip (include a stable filename for easy automation)
          cp "$ZIP_FILE" "Ferrufi-experimental.zip"
          echo "Uploading zip(s) to experimental release..."
          gh release upload experimental "$ZIP_FILE" "Ferrufi-experimental.zip" --clobber

          echo "âœ“ Experimental release updated successfully!"

      - name: Comment on commit (if push event)
        if: github.event_name == 'push'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_URL="${{ github.server_url }}/${{ github.repository }}/releases/tag/experimental"

          cat > comment.md <<EOF
          ## ðŸš€ Experimental Build Ready

          A new experimental build has been created from this commit!

          **Download:** [${{ steps.verify-build.outputs.zip_name }}]($RELEASE_URL)
          **Version:** ${{ steps.final-version.outputs.version }}
          **Build:** #${{ github.run_number }}
          **Size:** ${{ steps.verify-build.outputs.zip_size }}

          ### Quick Install
          \`\`\`bash
          # Download the zip from releases, then:
          unzip ${{ steps.verify-build.outputs.zip_name }}
          cp -R Ferrufi.app /Applications/
          xattr -cr /Applications/Ferrufi.app
          open /Applications/Ferrufi.app
          \`\`\`

          âš ï¸ **Note:** This is an unsigned experimental build for testing only.
          EOF

          # Try to comment on the commit (might fail if too many commits)
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/commits/${{ github.sha }}/comments" \
            -f body="$(cat comment.md)" \
            2>/dev/null || echo "Could not add commit comment (this is non-critical)"

      - name: Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          # âœ… Experimental App Build Complete

          ## Build Information
          - **Version:** ${{ steps.final-version.outputs.version }}
          - **Zip File:** ${{ steps.verify-build.outputs.zip_name }}
          - **Zip Size:** ${{ steps.verify-build.outputs.zip_size }}
          - **App Size:** ${{ steps.verify-build.outputs.app_size }}
          - **Swift Version:** ${{ steps.swift-version.outputs.version }}
          - **Build Number:** #${{ github.run_number }}
          - **Commit:** \`${{ github.sha }}\`
          - **Entitlements:** Applied âœ…

          ## Download
          - [Experimental Release](${{ github.server_url }}/${{ github.repository }}/releases/tag/experimental)
          - [Workflow Artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ## Installation
          \`\`\`bash
          # Download from releases, then:
          unzip ${{ steps.verify-build.outputs.zip_name }}
          cp -R Ferrufi.app /Applications/
          xattr -cr /Applications/Ferrufi.app
          open /Applications/Ferrufi.app
          \`\`\`

          ## Next Steps
          1. Download the zip from the experimental release
          2. Extract and test the application
          3. Report any issues

          ---

          ðŸŽ‰ Build completed successfully!
          EOF
