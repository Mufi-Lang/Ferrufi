name: macOS DMG Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 1.0.0)"
        required: true
        type: string
      codesign:
        description: "Enable code signing"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build-release-dmg:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read Swift tools version
        id: swift-version
        run: |
          SWIFT_VERSION=$(awk '/^\/\/ swift-tools-version:/ { print $3; exit }' Package.swift)
          echo "version=$SWIFT_VERSION" >> "$GITHUB_OUTPUT"
          echo "Detected Swift version: $SWIFT_VERSION"

      - name: Set up Swift toolchain
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: ${{ steps.swift-version.outputs.version }}

      - name: Determine release version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            # Manual workflow dispatch with version input
            VERSION="${{ inputs.version }}"
          elif [ -n "${{ github.ref_name }}" ] && [[ "${{ github.ref_name }}" == v* ]]; then
            # Tag push (strip 'v' prefix)
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
          else
            # Read from Version.swift
            MAJOR=$(grep -E '^\s*public static let major = ' Sources/Ferrufi/Version.swift | sed 's/.*= //' | tr -d ' ')
            MINOR=$(grep -E '^\s*public static let minor = ' Sources/Ferrufi/Version.swift | sed 's/.*= //' | tr -d ' ')
            PATCH=$(grep -E '^\s*public static let patch = ' Sources/Ferrufi/Version.swift | sed 's/.*= //' | tr -d ' ')
            VERSION="${MAJOR}.${MINOR}.${PATCH}"
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Release version: $VERSION"

      - name: Make scripts executable
        run: |
          chmod +x scripts/build_dmg_local.sh
          chmod +x scripts/set_version.sh
          chmod +x scripts/test_linking.sh

      - name: Verify dependencies
        run: |
          echo "Checking libmufiz.dylib..."
          if [ ! -f "Sources/CMufi/libmufiz.dylib" ]; then
            echo "ERROR: libmufiz.dylib not found!"
            exit 1
          fi

          echo "âœ“ libmufiz.dylib found"
          lipo -info Sources/CMufi/libmufiz.dylib

          echo "Architecture verification complete"

      - name: Run linking validation tests
        run: |
          ./scripts/test_linking.sh

      - name: Build Release DMG
        env:
          CODESIGN_IDENTITY: ${{ secrets.CODESIGN_IDENTITY }}
        run: |
          BUILD_ARGS="--version ${{ steps.version.outputs.version }}"

          # Add codesign flag if identity is available and enabled
          if [ -n "$CODESIGN_IDENTITY" ] && [ "${{ inputs.codesign }}" = "true" ]; then
            echo "Code signing enabled with identity: $CODESIGN_IDENTITY"
          else
            BUILD_ARGS="$BUILD_ARGS --no-codesign"
            echo "Building without code signing"
          fi

          ./scripts/build_dmg_local.sh $BUILD_ARGS

      - name: Verify DMG
        id: verify-dmg
        run: |
          DMG_FILE="Ferrufi-${{ steps.version.outputs.version }}-macos.dmg"

          if [ ! -f "$DMG_FILE" ]; then
            echo "ERROR: DMG file not created: $DMG_FILE"
            exit 1
          fi

          DMG_SIZE=$(du -h "$DMG_FILE" | cut -f1)
          echo "âœ“ DMG verified: $DMG_FILE ($DMG_SIZE)"

          echo "dmg_path=$DMG_FILE" >> "$GITHUB_OUTPUT"
          echo "dmg_name=$(basename $DMG_FILE)" >> "$GITHUB_OUTPUT"
          echo "dmg_size=$DMG_SIZE" >> "$GITHUB_OUTPUT"

      - name: Upload DMG as workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: ferrufi-release-dmg
          path: ${{ steps.verify-dmg.outputs.dmg_path }}
          retention-days: 90

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DMG_FILE="${{ steps.verify-dmg.outputs.dmg_path }}"
          TAG_NAME="v$VERSION"

          # Generate release notes
          cat > release_notes.md <<EOF
          # Ferrufi $VERSION

          Official release of Ferrufi version $VERSION.

          ## Installation

          1. Download \`${{ steps.verify-dmg.outputs.dmg_name }}\`
          2. Open the DMG file
          3. Drag Ferrufi.app to your Applications folder
          4. Launch Ferrufi from Applications

          ### First Launch (Unsigned Builds)

          If the app is not code-signed:
          1. Right-click Ferrufi.app and select "Open"
          2. Click "Open" in the security dialog
          3. The app will now launch normally

          ## What's New

          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/v$VERSION/CHANGELOG.md) for details.

          ## System Requirements

          - macOS 14.0 or later
          - Apple Silicon (arm64) recommended

          ## Build Information

          - **Version:** $VERSION
          - **Build Date:** $(date -u '+%Y-%m-%d')
          - **Swift Version:** ${{ steps.swift-version.outputs.version }}
          - **Commit:** \`${{ github.sha }}\`

          ## Download

          - **DMG:** ${{ steps.verify-dmg.outputs.dmg_name }} (${{ steps.verify-dmg.outputs.dmg_size }})

          ---

          For issues, please visit [GitHub Issues](https://github.com/${{ github.repository }}/issues)
          EOF

          # Check if release exists
          if gh release view "$TAG_NAME" >/dev/null 2>&1; then
            echo "Updating existing release $TAG_NAME..."
            gh release upload "$TAG_NAME" "$DMG_FILE" --clobber
            gh release edit "$TAG_NAME" --notes-file release_notes.md
          else
            echo "Creating new release $TAG_NAME..."
            gh release create "$TAG_NAME" \
              --title "Ferrufi $VERSION" \
              --notes-file release_notes.md \
              "$DMG_FILE"
          fi

          echo "âœ“ Release published: $TAG_NAME"

      - name: Build Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          # âœ… Release Build Complete

          ## Release Information
          - **Version:** ${{ steps.version.outputs.version }}
          - **DMG File:** ${{ steps.verify-dmg.outputs.dmg_name }}
          - **DMG Size:** ${{ steps.verify-dmg.outputs.dmg_size }}
          - **Swift Version:** ${{ steps.swift-version.outputs.version }}
          - **Code Signed:** ${{ inputs.codesign == true && 'Yes' || 'No' }}

          ## Build Details
          - **Trigger:** ${{ github.event_name }}
          - **Ref:** ${{ github.ref }}
          - **Commit:** \`${{ github.sha }}\`
          - **Run:** #${{ github.run_number }}

          ## Downloads
          - [Workflow Artifact](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF

          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            cat >> $GITHUB_STEP_SUMMARY <<EOF
          - [GitHub Release](${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }})
          EOF
          fi

          cat >> $GITHUB_STEP_SUMMARY <<EOF

          ---

          ðŸŽ‰ **Build completed successfully!**
          EOF
